# Doxee
Web application to upload files inside blockchain using Hyperledger Fabric v2 in AWS cloud environment. This application is developed using NestJS framework configured with Fastify in backend service. Frontend is developed using Next.js framework and tailwind-css to style components. The database used is a simple SQLite.


### Deployment configuration
The application can be deployed inside AWS EC2 instance or on-premise server. When the application is deployed in AWS EC2 service, the **blockchain.service** uses AWS SDK to communicate with AWS ManagedBlockchain Service, otherwise if the installation is done on-premise servers it communicates with AWS ManagedBlockchain Service, of Doxee in this case, through bash scripts. These scripts are discoverable under _backend/src/blockchain/scripts_ folder. To allow this behaviour methods inside blockchain.service must be updated following the commented lines inside the file. Script files uses certificates to connect to EC2 instance under backend/src/blockchain/certs folder. This folder have to be created due to is inside .gitignore file.

#### Env configuration backend
In backend project there is a config folder where the user can find three .env files to configure application for development, test and production stages.
<ul>
    <li>APP_MODE: can be INVITATION or CLIENT mode. Invitation mode is used to generate the first proposal. It communicates with Doxee network and generate a proposal for registered user in this application. The CLIENT mode enable user to configure his netowrk and upload files.</li>
    <li>DB: indicates the name of the file that will be generated by SQLite. In the creation phase an INVITATION or CLIENT suffix will be added based on the APP_MODE var.</li>
    <li>Mail Server: An SMTP Server can be configured to send communication via email. This is used for the MFA authentication step to send the authentication code to user.</li>
    <li>AWS: Under this section there are parameters of Doxee Network</li>
    <li>Hyperledger Fabric: Configuration to connect with blockchain. In this case these parameters will be filled when the user completes the Blockchain configuration inside his AWS account.</li>
</ul>
Inside config folder there are files like configuration.ts and validation.ts that are used to declare contraints and validate env vars during the startup of the service.

#### Env configuration frontend
The frontend configuration is really simple. The main configuration is made on backend service. Inside **next.config.js** file the only var that have to be changed is APP_MODE. This value must correspond with the value setted inside backend configuration.

### Chaincode (Smartcontract)
Chaincodes are defined under chain-document/chaincode folder. It's necessary to create a folder for each one and the name must correspond with the chaincode file. In this case the name of the folder documents correspond with documents.js file.
This configuration is mandatory beacuse is used by scripts to upload and install cahincode inside ec2 instance. Scripts like _configure-cahincode.sh_, _execute-config-cahincode-remote.sh_ and _transfer_smart-contract.sh_ have to be configured properly. 

These files are used by **chain-document.service** that encapsulates the entire business logic to deploy chaincode and implements methods to communicate with it.
The entry point of this service is implementd by the **chain-document.controller** whtat defines the endpoints to communicate with this one.

## Startup
### Backend startup
Install dependencies
```
npm i
```
Generate openapi .json file based on env you need. This file is mandatory to generate services under fronted service to communicate with backend.
```
npm run generate-openapi:dev
npm run generate-openapi:test
npm run generate-openapi:prod
```
Start backend
```
# development
npm run start:dev
# test
npm run start:test
# prod
npm run start:prod
```

### Frontend startup
Install dependencies
```
npm i
```
Generate client services based on **doxee-openapi.json** file to communicate with backend service.
```
npm run openapi-gen
```
Start frontend
```
# development
npm run dev

# prod env
npm run build
npm run start
```